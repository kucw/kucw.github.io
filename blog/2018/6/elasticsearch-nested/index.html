<!doctype html><html lang=zh-tw><head><meta charset=utf-8><title>ElasticSearch - 嵌套對象 nested
</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="介紹在 Elastic Search 中如何定義嵌套對象 nested 的 index，以及如何查詢帶有 nested 的文檔"><meta name=author content="古古"><meta property="og:image" content="https://kucw.io/images/logo.png"><meta name=generator content="Hugo 0.145.0 with theme pure"><link rel=stylesheet href=https://kucw.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://kucw.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://kucw.io/plugins/venobox/venobox.css><link rel=stylesheet href=https://kucw.io/plugins/medium-zoom/medium-zoom.css><link rel=stylesheet href=https://kucw.io/scss/style.min.d0dbde05028230889123aec57bd4277b184ffb8ec8b13e1dae16f3946be51984.css media=screen><link rel="shortcut icon" href=https://kucw.io/images/favicon.png type=image/x-icon><link rel=icon href=https://kucw.io/images/favicon.png type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-FDFT2W6V4S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NKQ46H0SJW")</script><script src=https://kucw.io/js/google-firebase-login.min.69fad9ce5fc6ddb2a672d6f8497b357c0eb6b5ff30ceea1601cdd8f2b936213b.js type=module></script></head><body><div class=preloader></div><header class=navigation><div class="container-fluid border-bottom fixed-top nav-background-color"><div class=nav-container><nav class="navbar navbar-expand-lg navbar-white bg-transparent px-0"><a class="navbar-brand desktop-view" href=https://kucw.io/><img class="img-fluid logo-with-text-size mx-1" src=https://kucw.io/images/logo-with-text-transparent.png alt>
</a><a class="navbar-brand navbar-brand-mobile mobile-view" href=https://kucw.io/><img class="img-fluid logo-thumb-sm rounded-circle" src=https://kucw.io/images/logo.png alt>
</a><button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mr-auto ml-2"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>線上課程</a><div class=dropdown-menu><a class=dropdown-item href=https://hahow.in/cr/kucw-github-hugo target=_blank rel=noopener>GitHub 免費架站術！輕鬆打造個人品牌</a>
<a class=dropdown-item href=https://hahow.in/cr/springboot target=_blank rel=noopener>Java 工程師必備！Spring Boot 零基礎入門</a>
<a class=dropdown-item href=https://hahow.in/cr/springsecurity target=_blank rel=noopener>資安一把罩！Spring Security 零基礎入門</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>自媒體 & 敗家專區</a><div class=dropdown-menu><a class=dropdown-item href=https://kucw.io/blog/as-a-content-creator/1>軟體工程師的自媒體之路</a></div></li><li class=nav-item><a class=nav-link href=https://kucw.io/>所有文章</a></li><li class=nav-item><a class=nav-link href=https://kucw.io/about>關於我</a></li><li class=nav-item><button id=algolia-search-btn class=algolia-search-btn><i class=ti-search></i></button></li></ul><ul class=navbar-nav><a class=nav-newsletter-link href=/bio target=_blank>電子報訂閱</a></ul></div></nav></div></div></header><div id=algolia-search-pop-overlay class=algolia-search-pop-overlay><div class="popup algolia-search-popup"><div class=algolia-search-header><span class=algolia-search-icon><i class=ti-search></i></span><div id=algolia-search-input-container class=algolia-search-input-container></div><span id=algolia-popup-btn-close class=algolia-popup-btn-close><i class=ti-close></i></span></div><div id=algolia-results class=algolia-results><div id=algolia-hits class=algolia-hits></div><div id=algolia-pagination class=algolia-pagination></div></div></div></div><div id=login-pop-overlay class=login-pop-overlay><div class="popup login-popup"><div class=login-popup-header><img class="img-fluid logo-with-text-size mx-1" src=https://kucw.io/images/logo-with-text-transparent.png alt><div id=login-popup-btn-close class=login-popup-btn-close><i class=ti-close></i></div></div><div class=login-popup-body><button class=google-login-btn id=google-login-btn>
<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.6 10.2c0-.7.0-1.4-.2-2H10V12h5.4c-.3 1.3-1 2.4-2 3v2.6h3.2c2-1.8 3-4.3 3-7.4z" fill="#4285f4"/><path fill-rule="evenodd" clip-rule="evenodd" d="M10 20c2.7.0 5-.9 6.6-2.4L13.4 15a6 6 0 01-9-3.2H1.1v2.6A10 10 0 0010 20z" fill="#34a853"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4.4 11.9a6 6 0 010-3.8V5.5H1.1a10 10 0 000 9l3.3-2.6z" fill="#fbbc05"/><path fill-rule="evenodd" clip-rule="evenodd" d="M10 4c1.5.0 2.8.5 3.8 1.5l2.9-2.9A10 10 0 001 5.5l3.3 2.6A6 6 0 0110 4z" fill="#ea4335"/></svg>
<span class=google-login-btn-text>使用 Google 登入</span></button><p class=login-terms>By signing in, you agree to 古古的後端筆記's terms of service and privacy policy.</p></div></div></div><section class=section-sm><div class="container pl-4 pr-4"><div class=row><div class="col-lg-10 mx-auto"><h1 class=blog-title>ElasticSearch - 嵌套對象 nested</h1><div class=author-details><div><img src=https://kucw.io/images/author-sm.png alt class="author-thumb-blog rounded-circle"></div><div><p>古古</p><p>2018/06/22</p></div></div><hr class=blog-start-divider><div class="content mb-4"><ul><li><p>由於在 ES 中，所有單個文檔的增刪改都是原子性的操作，因此將相關的實體數據都儲存在同一個文檔是很好的，且由於所有信息都在一個文檔中，因此當我們查詢時就沒有必要像 mysql 一樣去關聯很多張表，只要搜一遍文檔就可以查出所有需要的數據，查詢效率非常高</p></li><li><p>因此除了基本數據類型之外，ES 也支持使用複雜的數據類型，像是數組、內部對象，而要使用內部對象的話，需要使用 <code>nested</code> 來定義索引，使文檔內可以包含一個內部對象</p><ul><li><p>為什麼不用 object 而要使用 nested 來定義索引的原因是，object 類型會使得內部對象的關聯性丟失</p></li><li><p>這是因為 Lucene 底層其實沒有內部對象的概念，所以 ES 會利用簡單的列表儲存字段名和值，將 object 類型的對象層次攤平，再傳給 Lucene</p></li><li><p>假設 user 類型是 object，當插入一筆新的數據時，ES 會將他轉換為下面的內部文檔，其中可以看見 alice 和 white 的關聯性丟失了</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>PUT</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc/</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;John&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Smith&#34;</span> <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Alice&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;White&#34;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>轉換後的內部文檔</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span> <span style=color:#0a3069>&#34;alice&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;john&#34;</span> <span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user.last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span> <span style=color:#0a3069>&#34;smith&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;white&#34;</span> <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li><li><p>理論上從插入的數據來看，應該搜索 &ldquo;first 為 Alice 且 last 為 White&rdquo; 時，這個文檔才算符合條件被搜出來，其他的條件都不算符合，但是因為 ES 把 object 類型的對象攤平了，所以實際上如果搜索 &ldquo;first 為 Alice 且 last 為 Smith&rdquo;，這個文檔也會當作符合的文檔被搜出來，但這樣就違反我們的意願了，我們希望內部對象自己的關聯性還是存在的</p></li><li><p>因此在使用內部對象時，要改使用 <code>nested</code> 類型來取代 <code>object</code> 類型 (因為 nested 類型不會被攤平，下面說明)</p></li></ul></li><li><p>nested 類型就是為了解決 object 類型在對象數組上丟失關聯性的問題的，如果將字段設置為 nested 類型，那個每一個嵌套對象都會被索引為一個 &ldquo;隱藏的獨立文檔&rdquo;</p><ul><li><p>其本質上就是將數組中的每個對象作為分離出來的隱藏文檔進行索引，因此這也意味著每個嵌套對象可以獨立於其他對象被查詢</p></li><li><p>假設將上面的例子的 user 改為 nested 類型，經過 ES 轉換後的文檔如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#57606a>//嵌套文檔1
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span> <span style=color:#0a3069>&#34;alice&#34;</span> <span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user.last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span> <span style=color:#0a3069>&#34;white&#34;</span> <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#57606a>//嵌套文檔2
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span> <span style=color:#0a3069>&#34;john&#34;</span> <span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user.last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span> <span style=color:#0a3069>&#34;smith&#34;</span> <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#57606a>//根文檔，或者也可以稱為父文檔
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li><li><p>在獨立索引每一個嵌套對象後，對象中每個字段的相關性得以保留，因此我們查詢時，也僅返回那些真正符合條件的文檔</p></li><li><p>不僅如此，由於嵌套文檔直接儲存在文檔內部，因此查詢時嵌套文檔和根文檔的聯合成本很低，速度和單獨儲存幾乎一樣</p></li><li><p>但是要注意，查詢的時候返回的是整個文檔，而不是嵌套文檔本身，並且如果要增刪改一個嵌套對象，必須把整個文檔重新索引才可以</p></li></ul></li><li><p>具體實例</p><ul><li><p>索引準備</p><ul><li><p>定義一個 nested 類型的 mapping，user 是一個內部對象，裡面包含了 first、last 和 age，因為 user 設置了 nested 類型，因此 user 對象會被索引在獨立的嵌套文檔中</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>PUT</span> <span style=color:#f6f8fa;background-color:#82071e>mytest</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;mappings&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    	<span style=color:#0550ae>&#34;doc&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        	<span style=color:#0550ae>&#34;properties&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#57606a>//group是正常的keyword字段
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>                <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;keyword&#34;</span> <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                <span style=color:#57606a>//user是一個nested類型，表示他底下還會包含子對象
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            	<span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                	<span style=color:#0550ae>&#34;type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;nested&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;properties&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    	<span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#0550ae>&#34;type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;keyword&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#0550ae>&#34;type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;keyword&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#0550ae>&#34;type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li><li><p>插入兩筆數據</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>POST</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Taylor&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Swift&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>30</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>POST</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Amy&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;White&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>18</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;John&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Smith&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>22</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>]</span>    
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li><li><p>因此在ES中存在的文檔如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#0a3069>&#34;hits&#34;</span><span style=color:#f6f8fa;background-color:#82071e>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;_source&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Taylor&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Swift&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>30</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;_source&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Amy&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;White&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>18</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;John&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Smith&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>22</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>]</span>
</span></span></code></pre></div></li></ul></li></ul></li><li><p>嵌套對象查詢 nested</p><ul><li><p>由於嵌套對象被索引在獨立的隱藏文檔中，因此我們無法直接使用一般的 query 去查詢他，我們必須改使用 &ldquo;nested查詢&rdquo; 去查詢他們</p><ul><li>nested 查詢是一個葉子子句，因此外層需要使用 query 或是 bool 來包含他，且因為 nested 查詢是一個葉子子句，所以他也可以像一般的葉子子句一樣被 bool 層層嵌套</li><li>nested 查詢的內部必須要包含一個 <code>path</code> 參數，負責指定要用的是哪個 nested 類型的字段，且要包含一個 <code>query</code>，負責進行此嵌套對象內的查詢</li></ul></li><li><p>如果是將 bool 子句寫在 nested 裡面，表示要查詢某個子對象中，必須同時包含這兩個條件</p><ul><li><p>也就是說，下面的查詢實際上是查找必須存在一個子對象，然後此對象必須同時滿足 <code>user.first</code> 為 Taylor，且 <code>user.last</code> 為 Swift，所以能夠找到一個存在的文檔</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>GET</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc/_search</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        	<span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;bool&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                	<span style=color:#0550ae>&#34;must&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Taylor&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;user.last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Swift&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#0a3069>&#34;hits&#34;</span><span style=color:#f6f8fa;background-color:#82071e>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;_source&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Taylor&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Swift&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>30</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>]</span>
</span></span></code></pre></div></li><li><p>但將查詢改寫成下面這樣的話，則搜索不到任何結果，因為沒有一個子對象同時滿足 <code>user.first</code> 為 Taylor 且 <code>user.last</code> 為xxx</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>GET</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc/_search</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        	<span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;bool&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                	<span style=color:#0550ae>&#34;must&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Taylor&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;user.last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;xxx&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li></ul></li><li><p>而如果是將 bool 子句寫在 nested 的外面，表示要查詢此 nested 對象兩次，而這兩次是分別使用不同的條件，因此不需要一定要同一個子對象中同時滿足這兩個條件</p><ul><li><p>下面的查詢表示只要 user 中包含 <code>user.first</code> 為 Amy，且也包含 <code>user.last</code> 為 Smith 就行了，但不是要求一定要有一個子對象是 <code>user.first</code> 為 Amy 且他的 <code>user.last</code> 剛好也是 Smith，所以結果才能搜出一個文檔</p></li><li><p>如果這裡將 bool 改寫在 nested 裡面，那就搜不出任何文檔了</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>GET</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc/_search</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;bool&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;filter&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Amy&#34;</span>
</span></span><span style=display:flex><span>                            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#0550ae>&#34;user.last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Smith&#34;</span>
</span></span><span style=display:flex><span>                            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#0a3069>&#34;hits&#34;</span><span style=color:#f6f8fa;background-color:#82071e>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;_source&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Amy&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;White&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>18</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;John&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Smith&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>22</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>]</span>
</span></span></code></pre></div></li></ul></li><li><p>和 bool 的其他葉子子句（term、range&mldr;）一起搭配使用的 nested 查詢</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>GET</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc/_search</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    	<span style=color:#0550ae>&#34;bool&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        	<span style=color:#0550ae>&#34;filter&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            		<span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                		<span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span>
</span></span><span style=display:flex><span>               		<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            	<span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    	<span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                        	<span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Amy&#34;</span>
</span></span><span style=display:flex><span>                            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>      		<span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li></ul></li><li><p>嵌套對象的評分 score_mode</p><ul><li><p>假設 nested 類型的 user，儲存的是一個數組，那麼在進行嵌套查詢時，可能會匹配到多個嵌套的文檔，而每一個匹配的嵌套文檔都有自己的相關度得分</p><ul><li><p>假設有一個文檔如下，一個根文檔內，包含了3個嵌套文檔</p></li><li><p>當查詢 &ldquo;user.first = July 或 user.last = Month&rdquo; 時，第一個嵌套文檔的分數最高，第二個嵌套文檔次之，第三個嵌套文檔的分數最低</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#0a3069>&#34;hits&#34;</span><span style=color:#f6f8fa;background-color:#82071e>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;_source&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;group&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;fans&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;user&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;July&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Month&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>18</span> <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Aug&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Month&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>22</span> <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Monday&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Day&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&#34;age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>25</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>]</span>
</span></span></code></pre></div></li></ul></li><li><p>為了匯集這眾多的嵌套文檔分數到根文檔，就需要設置 score_mode 來指定怎樣去計算這些嵌套文檔的總分</p><ul><li><p>默認情況下，根文檔的分數是這些嵌套文檔分數的平均值，就是默認 score_mode = avg</p></li><li><p>可以透過設置 score_mode 為 avg、max、sum、none (直接返回1.0常數值分數)，來控制根文檔的得分策略</p></li><li><p>不過要注意，如果 nested 查詢放在一個 filter 子句中，就算定義了 score_mode 也不會生效，因為 filter 不打分，所以 score_mode 就沒有任何意義</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>GET</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc/_search</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        	<span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;score_mode&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;max&#34;</span><span style=color:#1f2328>,</span> <span style=color:#57606a>//返回最佳匹配嵌套文檔的_score給根文檔使用
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;bool&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                	<span style=color:#0550ae>&#34;should&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;July&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;user.last&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Month&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li></ul></li></ul></li><li><p>使用嵌套對象的字段來排序</p><ul><li>儘管嵌套對象儲存於獨立的隱藏文檔中，但依然有方法按照嵌套字段的值排序</li><li>假設我們想要查出 user.first 為 Amy，且依照 user.age 這個內部對象的字段，由小到大進行排序，查詢語句如下<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>GET</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/doc/_search</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;query&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;term&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;user.first&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Amy&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;sort&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#0550ae>&#34;user.age&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;nested&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;user&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;order&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;asc&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li></ul></li></ul></div><div class=blog-newsletter><h4>免費訂閱《古古的後端筆記》電子報（長期休刊中）</h4><div><p>每週二學習後端技術，和 3500 人一起變強💪</p><div id=blog-newsletter class=newsletter><div class="row justify-content-center"><div class=col-md-8><div class=success>已發送 Email 驗證信！請前往信箱驗證你的訂閱</div><div class=error>訂閱失敗，請檢查 Email 是否輸入錯誤，或是聯繫 service@kucw.io 取得協助</div><div class=maintenance>電子報伺服器正在維護中，請稍後再試</div></div></div><form action=# method=POST class="row justify-content-center"><div class="input-group col-md-8"><input type=email required name=email class=form-control placeholder="輸入你的 Email"><div class=input-group-append><button type=submit class="input-group-text btn btn-primary">
免費訂閱</button></div></div></form></div></div></div><hr class=blog-end-divider><script src=https://utteranc.es/client.js label=comment repo=kucw/kucw.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></div></section><footer><div class=container><div class="row justify-content-center pb-4"><div class="col-12 text-center mb-5"><a href=https://kucw.io/><img class="img-fluid logo-thumb-md rounded-circle mx-1" src=https://kucw.io/images/logo.png alt=古古的後端筆記></a></div></div><div class="row pb-1"><div class="col-lg-8 text-center pb-5"><h4>免費訂閱電子報，每週二學習後端技術🚀<br>（長期休刊中）</h4><div id=footer-newsletter class=newsletter><div class="row justify-content-center"><div class=col-md-8><div class=success>已發送 Email 驗證信！請前往信箱驗證你的訂閱</div><div class=error>訂閱失敗，請檢查 Email 是否輸入錯誤，或是聯繫 service@kucw.io 取得協助</div><div class=maintenance>電子報伺服器正在維護中，請稍後再試</div></div></div><form action=# method=POST class="row justify-content-center"><div class="input-group col-md-8"><input type=email required name=email class=form-control placeholder="輸入你的 Email"><div class=input-group-append><button type=submit class="input-group-text btn btn-primary">
免費訂閱</button></div></div></form></div></div><div class="col-lg-4 pb-3 footer-contact-me"><h5 class=mb-4>追蹤古古</h5><ul class="list-inline footer-social-links"><li class=list-inline-item><a href=https://github.com/kucw target=_blank rel=noopener><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.facebook.com/kucw.io target=_blank rel=noopener><i class=ti-facebook></i></a></li><li class=list-inline-item><a href=https://www.instagram.com/kucw.io/ target=_blank rel=noopener><i class=ti-instagram></i></a></li></ul><p>聯絡信箱: service@kucw.io</p></div></div><div class="border-top py-4 text-center">© 2020-2025 古古的後端筆記 | All Rights Reserved.</div></div></div></footer><script>var indexURL="https://kucw.io/index.json"</script><script src=https://kucw.io/plugins/jQuery/jquery.min.js></script><script src=https://kucw.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://kucw.io/plugins/mailbluster/mailbluster.js></script><script src=https://kucw.io/plugins/confetti/confetti.browser.min.js></script><script src=https://kucw.io/plugins/confetti/welcomeConfetti.js></script><script src=https://kucw.io/plugins/medium-zoom/medium-zoom.min.js></script><script src=https://kucw.io/plugins/algolia-search/algoliasearch.js></script><script src=https://kucw.io/plugins/algolia-search/algoliasearch-lite.umd.js></script><script src=https://kucw.io/plugins/algolia-search/instantsearch.production.min.js></script><script src=https://kucw.io/plugins/clipboard/clipboard.min.js></script><script src=https://kucw.io/plugins/clipboard/code-clipboard.js></script><script src=https://kucw.io/plugins/login/login.js></script><script src=https://kucw.io/js/script.min.aa7e377695025ea8426da51bc7ddbc5d24fa31916deb7d8d442296c493598de4.js></script></body></html>