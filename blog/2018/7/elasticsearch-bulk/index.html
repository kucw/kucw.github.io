<!doctype html><html lang=zh-tw><head><meta charset=utf-8><title>ElasticSearch - 批量操作 bulk
</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="介紹如何使用 Elastic Search 的批量操作 bulk"><meta name=author content="古古"><meta property="og:image" content="https://kucw.io/images/logo.png"><meta name=generator content="Hugo 0.145.0 with theme pure"><link rel=stylesheet href=https://kucw.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://kucw.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://kucw.io/plugins/venobox/venobox.css><link rel=stylesheet href=https://kucw.io/plugins/medium-zoom/medium-zoom.css><link rel=stylesheet href=https://kucw.io/scss/style.min.df4427c51fb7a8dce534f2f0d97b721359a811c30e2435983d153d0af3d00420.css media=screen><link rel="shortcut icon" href=https://kucw.io/images/favicon.png type=image/x-icon><link rel=icon href=https://kucw.io/images/favicon.png type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-FDFT2W6V4S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NKQ46H0SJW")</script><script src=https://kucw.io/js/google-firebase-login.min.69fad9ce5fc6ddb2a672d6f8497b357c0eb6b5ff30ceea1601cdd8f2b936213b.js type=module></script></head><body><div class=preloader></div><header class=navigation><div class="container-fluid border-bottom fixed-top nav-background-color"><div class=nav-container><nav class="navbar navbar-expand-lg navbar-white bg-transparent px-0"><a class="navbar-brand desktop-view" href=https://kucw.io/><img class="img-fluid logo-with-text-size mx-1" src=https://kucw.io/images/logo-with-text-transparent.png alt>
</a><a class="navbar-brand navbar-brand-mobile mobile-view" href=https://kucw.io/><img class="img-fluid logo-thumb-sm rounded-circle" src=https://kucw.io/images/logo.png alt>
</a><button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mr-auto ml-2"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>後端 & 手機端技術專欄</a><div class=dropdown-menu><a class=dropdown-item href=https://kucw.io/blog/springboot/1>後端 - Spring Boot 零基礎入門</a>
<a class=dropdown-item href=https://kucw.io/blog/android/1>手機端 - Android 零基礎入門</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>線上課程</a><div class=dropdown-menu><a class=dropdown-item href=https://hahow.in/cr/kucw-github-hugo target=_blank rel=noopener>GitHub 免費架站術！輕鬆打造個人品牌</a>
<a class=dropdown-item href=https://hahow.in/cr/springboot target=_blank rel=noopener>Java 工程師必備！Spring Boot 零基礎入門</a>
<a class=dropdown-item href=https://hahow.in/cr/springsecurity target=_blank rel=noopener>資安一把罩！Spring Security 零基礎入門</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>自媒體 & 敗家專區</a><div class=dropdown-menu><a class=dropdown-item href=https://kucw.io/blog/as-a-content-creator/1>軟體工程師的自媒體之路</a></div></li><li class=nav-item><a class=nav-link href=https://kucw.io/>所有文章</a></li><li class=nav-item><a class=nav-link href=https://kucw.io/about>關於我</a></li><li class=nav-item><button id=algolia-search-btn class=algolia-search-btn><i class=ti-search></i></button></li></ul><ul class=navbar-nav><a class=nav-newsletter-link href=/bio target=_blank>電子報訂閱</a></ul></div></nav></div></div></header><div id=algolia-search-pop-overlay class=algolia-search-pop-overlay><div class="popup algolia-search-popup"><div class=algolia-search-header><span class=algolia-search-icon><i class=ti-search></i></span><div id=algolia-search-input-container class=algolia-search-input-container></div><span id=algolia-popup-btn-close class=algolia-popup-btn-close><i class=ti-close></i></span></div><div id=algolia-results class=algolia-results><div id=algolia-hits class=algolia-hits></div><div id=algolia-pagination class=algolia-pagination></div></div></div></div><div id=login-pop-overlay class=login-pop-overlay><div class="popup login-popup"><div class=login-popup-header><img class="img-fluid logo-with-text-size mx-1" src=https://kucw.io/images/logo-with-text-transparent.png alt><div id=login-popup-btn-close class=login-popup-btn-close><i class=ti-close></i></div></div><div class=login-popup-body><button class=google-login-btn id=google-login-btn>
<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.6 10.2c0-.7.0-1.4-.2-2H10V12h5.4c-.3 1.3-1 2.4-2 3v2.6h3.2c2-1.8 3-4.3 3-7.4z" fill="#4285f4"/><path fill-rule="evenodd" clip-rule="evenodd" d="M10 20c2.7.0 5-.9 6.6-2.4L13.4 15a6 6 0 01-9-3.2H1.1v2.6A10 10 0 0010 20z" fill="#34a853"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4.4 11.9a6 6 0 010-3.8V5.5H1.1a10 10 0 000 9l3.3-2.6z" fill="#fbbc05"/><path fill-rule="evenodd" clip-rule="evenodd" d="M10 4c1.5.0 2.8.5 3.8 1.5l2.9-2.9A10 10 0 001 5.5l3.3 2.6A6 6 0 0110 4z" fill="#ea4335"/></svg>
<span class=google-login-btn-text>使用 Google 登入</span></button><p class=login-terms>By signing in, you agree to 古古的後端筆記's terms of service and privacy policy.</p></div></div></div><section class=section-sm><div class="container pl-4 pr-4"><div class=row><div class="col-lg-10 mx-auto"><h1 class=blog-title>ElasticSearch - 批量操作 bulk</h1><div class=author-details><div><img src=https://kucw.io/images/author-sm.png alt class="author-thumb-blog rounded-circle"></div><div><p>古古</p><p>2018/07/30</p></div></div><hr class=blog-start-divider><div class="content mb-4"><ul><li><p>ES 的 <code>bulk</code> 語法允許在一個請求中進行多個操作（create、index、update、delete），也就是可以在一次請求裡做很多事情</p><ul><li>也由於這個關係，因此 bulk 的請求體和其他請求的格式會有點不同</li></ul></li><li><p>bulk 的請求模板</p><ul><li>分成 action 和 metadata 兩部份</li><li>action : 必須是以下 4 種選項之一<ul><li><code>index</code>(最常用） : 如果文檔不存在就創建他，如果文檔存在就更新他</li><li><code>create</code> : 如果文檔不存在就創建他，但如果文檔存在就返回錯誤<ul><li>使用時一定要在 metadata 設置 <code>_id</code> 值，他才能去判斷這個文檔是否存在</li></ul></li><li><code>update</code> : 更新一個文檔，如果文檔不存在就返回錯誤<ul><li>使用時也要給 <code>_id</code> 值，且後面文檔的格式和其他人不一樣</li></ul></li><li><code>delete</code> : 刪除一個文檔，如果要刪除的文檔 id 不存在，就返回錯誤<ul><li>使用時也必須在 metadata 中設置文檔 <code>_id</code>，且後面不能帶一個 doc，因為沒意義，他是用 <code>_id</code> 去刪除文檔的</li></ul></li></ul></li><li>metadata : 設置這個文檔的 metadata，像是 <code>_id</code>、<code>_index</code><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>POST</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/_bulk</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#f6f8fa;background-color:#82071e>action</span> <span style=color:#f6f8fa;background-color:#82071e>:</span> <span style=color:#f6f8fa;background-color:#82071e>{</span> <span style=color:#f6f8fa;background-color:#82071e>metadata</span> <span style=color:#1f2328>}</span> <span style=color:#f6f8fa;background-color:#82071e>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#f6f8fa;background-color:#82071e>doc</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#f6f8fa;background-color:#82071e>action</span> <span style=color:#f6f8fa;background-color:#82071e>:</span> <span style=color:#f6f8fa;background-color:#82071e>{</span> <span style=color:#f6f8fa;background-color:#82071e>metadata</span> <span style=color:#1f2328>}</span> <span style=color:#f6f8fa;background-color:#82071e>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#f6f8fa;background-color:#82071e>doc</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>....</span>
</span></span></code></pre></div></li></ul></li><li><p>具體實例</p><ul><li><p>bulk請求</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>POST</span> <span style=color:#f6f8fa;background-color:#82071e>mytest/_bulk</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//創建一筆數據
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;create&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;color&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;create black&#34;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//創建一筆數據，因為id=1的文檔已經存在，所以會創建失敗
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;create&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;color&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;create black2&#34;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//索引一筆數據
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;index&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>2</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;color&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;index red&#34;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//索引一筆數據，但是index可以創建也可以更新，所以執行成功
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;index&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>2</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;color&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;index red2&#34;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//索引一筆數據，不一定要設置id(index又能創建又能更新又不用設id，超好用)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;color&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;index blue&#34;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//刪除一筆文檔，注意delete後面不接一個doc
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;delete&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;2&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//找不到此id的文檔，刪除失敗
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;delete&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;2&#34;</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//更新一筆文檔，注意doc格式不太一樣
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;update&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;doc&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;color&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;update green&#34;</span><span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>//更新一筆文檔，但因為此id的文檔不存在，所以更新失敗
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;update&#34;</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;doc&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>&#34;color&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;update green2&#34;</span><span style=color:#1f2328>}</span> <span style=color:#1f2328>}</span>
</span></span></code></pre></div></li></ul></li><li><p>bulk 的返回結果</p><ul><li><p>因為在 bulk 中，每個 action 的執行結果都是獨立的，所以有幾個 action，就會有幾個返回結果，返回結果如下</p><ul><li>最上面會有一個 <code>errors</code>，表示這一次 bulk 請求中，是否有 action 出錯了</li><li>因此寫代碼時可以先檢查 <code>errors</code> 這個值，如果是 false，表示這次 bulk 請求全部通過，就不用再一一去檢查是否有 action 出錯，但如果是 true，則必須去 <code>items</code> 一個一個檢查到底是哪個 action 出錯了</li></ul></li><li><p><code>items</code> 是一個 array，裡面則放著每個 action 對應的結果，上面的請求執行了 9 個 action，所以返回結果的 items 就會有 9 個</p><ul><li>返回結果會依照 action 的順序排好，因此 <code>items</code> 的第一個結果就是請求時第一個 action 的執行結果<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;took&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>145</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;errors&#34;</span><span style=color:#1f2328>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>&#34;items&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;create&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;mytest&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;_doc&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;1&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;result&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;created&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;status&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>201</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;create&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;mytest&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;_doc&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;1&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;status&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>409</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;error&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;version_conflict_engine_exception&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;reason&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;[1]: version conflict, document already exists (current version [1])&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;index_uuid&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;PfdgdTyiRgaCIM6uKRQAPQ&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;shard&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;0&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#0550ae>&#34;index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;mytest&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;mytest&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;_doc&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;2&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;result&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;created&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;status&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>201</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&#34;index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_index&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;mytest&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_type&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;_doc&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;_id&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;2&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;result&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;updated&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>&#34;status&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>200</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f6f8fa;background-color:#82071e>...</span> <span style=color:#0550ae>5</span> <span style=color:#f6f8fa;background-color:#82071e>RESULTS</span> <span style=color:#f6f8fa;background-color:#82071e>REMOVED</span> <span style=color:#f6f8fa;background-color:#82071e>...</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></li></ul></li></ul></li><li><p>使用 bulk 要注意的地方</p><ul><li>如果使用 <code>127.0.0.1/_bulk</code>，那麼就是在整個 ES 的範圍中插入數據，因此在 metadata 中要指定插入的 index，優點是可以一次插入多筆數據到不同的索引<ul><li>而如果使用 <code>127.0.0.1/mytest/_bulk</code>，就不用在 metadata 再次指定要插入的 index，可以想像成是 <code>_bulk</code> API幫我們自動填好了 metadata 的 <code>_index</code>，很方便</li></ul></li><li>還有因為 bulk 和其他請求的格式不同，或是說基本上他已經不是正常的 json 格式了，所以在使用 bulk 時，HTTP header 要使用 <code>application/x-ndjson</code><ul><li>而且每一行的結尾，都要使用 <code>\n</code>，如果是一般在 postman 寫請求不會有問題，但是如果是使用 <code>curl</code> 來發送請求，就要使用 <code>--data-binary</code>，才會使每一句的結尾都是 <code>\n</code></li></ul></li></ul></li><li><p>多大是太大了？</p><ul><li>由於整個 <code>bulk</code> 批量請求都需要由接收到請求的節點加載到內存中，因此該請求越大，其他請求所能獲得的內存就越少</li><li>批量請求的大小有一個最佳值，大於這個值，性能將不再提升，甚至會下降，但是最佳值不是一個固定的值，它完全取決於硬件、文檔的大小和複雜度、索引和搜索的負載的整體情況</li><li>幸運的是，很容易找到這個最佳點 ：可以通過批量索引文檔，並不斷增加批量大小進行嘗試，當性能開始下降時，那就表示你的批量大小太大了<ul><li>一個好的辦法是開始時將 1000 到 5000 個文檔作爲一個批次慢慢增長，試圖找到最佳點</li><li>但是如果你的文檔非常大，那麼就必須減少批量的文檔個數，密切關注你的批量請求的物理大小往往非常有用，一千個 1KB 的文檔是完全不同於一千個 1MB 文檔所佔的物理大小，一個好的批量大小在開始處理後所佔用的物理大小約爲 5-15 MB</li></ul></li></ul></li></ul></div><div class=blog-newsletter><h4>免費訂閱《古古的後端筆記》電子報（長期休刊中）</h4><div><p>每週二學習後端技術，和 3600 人一起變強💪</p><div id=blog-newsletter class=newsletter><div class="row justify-content-center"><div class=col-md-8><div class=success>已發送 Email 驗證信！請前往信箱驗證你的訂閱</div><div class=error>訂閱失敗，請檢查 Email 是否輸入錯誤，或是聯繫 service@kucw.io 取得協助</div><div class=maintenance>電子報伺服器正在維護中，請稍後再試</div></div></div><form action=# method=POST class="row justify-content-center"><div class="input-group col-md-8"><input type=email required name=email class=form-control placeholder="輸入你的 Email"><div class=input-group-append><button type=submit class="input-group-text btn btn-primary">
免費訂閱</button></div></div></form></div></div></div><hr class=blog-end-divider><script src=https://utteranc.es/client.js label=comment repo=kucw/kucw.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></div></section><footer><div class=container><div class="row justify-content-center pb-4"><div class="col-12 text-center mb-5"><a href=https://kucw.io/><img class="img-fluid logo-thumb-md rounded-circle mx-1" src=https://kucw.io/images/logo.png alt=古古的後端筆記></a></div></div><div class="row pb-1"><div class="col-lg-8 text-center pb-5"><h4>免費訂閱電子報，每週二學習後端技術🚀<br>（長期休刊中）</h4><div id=footer-newsletter class=newsletter><div class="row justify-content-center"><div class=col-md-8><div class=success>已發送 Email 驗證信！請前往信箱驗證你的訂閱</div><div class=error>訂閱失敗，請檢查 Email 是否輸入錯誤，或是聯繫 service@kucw.io 取得協助</div><div class=maintenance>電子報伺服器正在維護中，請稍後再試</div></div></div><form action=# method=POST class="row justify-content-center"><div class="input-group col-md-8"><input type=email required name=email class=form-control placeholder="輸入你的 Email"><div class=input-group-append><button type=submit class="input-group-text btn btn-primary">
免費訂閱</button></div></div></form></div></div><div class="col-lg-4 pb-3 footer-contact-me"><h5 class=mb-4>追蹤古古</h5><ul class="list-inline footer-social-links"><li class=list-inline-item><a href=https://github.com/kucw target=_blank rel=noopener><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.facebook.com/kucw.io target=_blank rel=noopener><i class=ti-facebook></i></a></li><li class=list-inline-item><a href=https://www.instagram.com/kucw.io/ target=_blank rel=noopener><i class=ti-instagram></i></a></li></ul><p>聯絡信箱: service@kucw.io</p></div></div><div class="border-top py-4 text-center">© 2020-2026 古古的後端筆記 | All Rights Reserved.</div></div></div></footer><script>var indexURL="https://kucw.io/index.json"</script><script src=https://kucw.io/plugins/jQuery/jquery.min.js></script><script src=https://kucw.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://kucw.io/plugins/mailbluster/mailbluster.js></script><script src=https://kucw.io/plugins/confetti/confetti.browser.min.js></script><script src=https://kucw.io/plugins/confetti/welcomeConfetti.js></script><script src=https://kucw.io/plugins/medium-zoom/medium-zoom.min.js></script><script src=https://kucw.io/plugins/algolia-search/algoliasearch.js></script><script src=https://kucw.io/plugins/algolia-search/algoliasearch-lite.umd.js></script><script src=https://kucw.io/plugins/algolia-search/instantsearch.production.min.js></script><script src=https://kucw.io/plugins/clipboard/clipboard.min.js></script><script src=https://kucw.io/plugins/clipboard/code-clipboard.js></script><script src=https://kucw.io/plugins/login/login.js></script><script src=https://kucw.io/js/script.min.aa7e377695025ea8426da51bc7ddbc5d24fa31916deb7d8d442296c493598de4.js></script></body></html>